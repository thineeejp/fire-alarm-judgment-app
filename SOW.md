承知いたしました。
特小自火報の判定フローが「イ→ロ→ハ」の順で正しく逐次的に実行されるようにロジックを修正するための、最終版の作業指示書（SOW）を作成します。

---

## **作業指示書 (SOW)**

**プロジェクト名:** 特小自火報判定における逐次判定フローのロジック修正

**発行日:** 2025/08/18

**バージョン:** 6.0 (判定フロー制御 最終版)

---

### 1. プロジェクト概要

本プロジェクトは、「自動火災報知設備 判定アプリ」の`hantei.js`に実装されている`特小判定実行`関数に存在する、フロー制御の重大な欠陥を修正するものである。
現状のロジックでは、特小自火報の設置可否を判定する際、「イ号→ロ号→ハ号」の順で判定が試行されるべきところ、途中の「ロ号」判定で失敗した場合に、その理由を最終的な否決理由としてしまい、後続の「ハ号」の判定を事実上無効化してしまう。
これにより、本来は「ハ号」に該当して「設置可能」となるべきケースが、「ロ号の要件を満たさない」という理由で誤って「設置不可」と判定される問題が発生している。本作業では、このフローを修正し、全ての可能性を正しく順に検証するロジックを確立する。

### 2. 目的とゴール

*   **目的:** `特小判定実行`関数が、必ず「イ→ロ→ハ」の優先順位でフォールバックしながら判定を試行するように、そのフロー制御を修正する。
*   **ゴール:**
    1.  `hantei.js`を修正し、いずれかの号（イ, ロ, ハ）で「設置可能」と判定された時点で、その結果を最終的な成功結果として返すようにする。
    2.  途中の号（例: ロ号）で判定が失敗しても、それが最終的な否決理由となることを防ぎ、必ず後続の号（例: ハ号）の判定を試行するようにする。
    3.  全ての号の判定に失敗した場合にのみ、「設置不可」という最終結論を返すようにする。

### 3. 作業範囲 (Scope of Work)

*   **修正対象ファイル:** `hantei.js`
*   **修正対象関数:** `特小判定実行`
*   **具体的なタスク:**
    1.  関数内のフロー制御構造を見直す。`設置可能フラグ`が`true`になった時点で、後続の判定ブロック（`if (!設置可能フラグ)`）が実行されないようにする。
    2.  **ロ号の判定ブロック**を修正する。
        *   ロ号の条件を満たさず失敗した場合、その理由（`理由_ロ`）をローカルな変数に留め、**最終的な否決理由を格納する変数（`否決理由`）には代入しない**こと。単に`設置可能フラグ`が`false`のまま、次のハ号判定ブロックへ処理を移行させる。
    3.  **ハ号の判定ブロック**を修正する。
        *   ハ号の条件を満たさず失敗した場合、その理由（`理由_ハ`）を**最終的な否決理由を格納する変数（`否決理由`）に代入する**。
    4.  **最終結果の返却ブロック**を修正する。
        *   全ての判定が終了した時点で`設置可能フラグ`が`false`の場合、`否決理由`変数に格納された値（ハ号の失敗理由、またはそれが空の場合は汎用的なメッセージ）を最終的な根拠として返すようにする。

### 4. 成果物 (Deliverables)

1.  上記タスクが全て適用された `hantei.js` ファイル。
2.  実行した変更内容のサマリーレポート。

### 5. 受入基準 (Acceptance Criteria)

以下の全ての基準を満たした場合に、本作業は完了とみなされる。

1.  **コードの確認:** `特小判定実行`関数内のロ号判定ブロックで、判定失敗時に最終的な`否決理由`変数を設定していないこと。また、ハ号判定ブロックでのみ、失敗時に`否決理由`が設定されるようになっていること。

2.  **受入テストケース: 逐次判定フローの検証**
    *   **入力:**
        *   主用途: `(16)項イ`
        *   延べ面積: **350㎡**
        *   「小規模特複」フラグ: **OFF (いいえ)**
        *   複合用途1: `(5)項イ` (ホテル), 面積: 50㎡
        *   複合用途2: `(5)項ロ` (寄宿舎), 面積: 300㎡
    *   **判定ロジックの期待動作:**
        1.  **イ号判定:** 延べ面積が300㎡以上のため、**失敗**する。`設置可能フラグ`は `false` のまま。
        2.  **ロ号判定:** `is小規模特複フラグ`が `false` のため、**失敗**する。しかし、この時点では最終的な否決理由は設定されず、`設置可能フラグ`は `false` のまま次の判定に進む。
        3.  **ハ号判定:** 構成用途が(5)項イ・ロのみ、(5)項イの面積が300㎡未満、延べ面積が300〜500㎡の範囲内、という全ての条件を満たすため、**成功**する。
        4.  `設置可能フラグ`が`true`に、`判定根拠号`が`"ハ号"`に設定される。
    *   **期待される最終結果:**
        *   アプリケーションが表示する特小自火報の判定結果が**「設置可能」**となること。
        *   その根拠として「**特定小規模施設に関する省令 第2条第1号【ハ号】に該当します。**」という趣旨のメッセージが表示されること。
        *   （誤った動作である「『小規模特定用途複合防火対象物』に該当しないため、ロ号の対象外です。」というメッセージが表示されないこと。）

**コード例**
/**
 * 特定小規模施設用自動火災報知設備の設置可否を判定するメイン関数 (【イ→ロ→ハ逐次判定 修正版】)
 * @param {object} 判定結果_令21 - 判定実行_令21の実行結果
 * @param {object} 建物情報 - ユーザー入力から生成された建物情報オブジェクト
 * @returns {object} 判定結果オブジェクト
 */
function 特小判定実行(判定結果_令21, 建物情報) {
    // --- STEP 0: 前提条件のチェック ---
    if (判定結果_令21.根拠リスト.length === 0) {
        return { 設置可否: "判定対象外", 根拠: "自火報の設置義務がありません", 該当号: null };
    }

    let 設置可能フラグ = false;
    let 判定根拠号 = null;
    let 否決理由 = ""; // 最終的な否決理由を格納する変数

    // === イ号の判定 ===
    const 除外号リスト_イ = ["3号", "4号", "5号", "6号", "8号", "11号", "12号", "14号", "15号"];
    const 根拠号が対象か_イ = 判定結果_令21.根拠リスト.every(号 => !除外号リスト_イ.includes(号));

    if (根拠号が対象か_イ) {
        if (建物情報.延べ面積 < 300) {
            設置可能フラグ = true;
            判定根拠号 = "イ号";
        }
    }

    // === ロ号の判定 ===
    // ★★★ イ号で設置可能にならなかった場合にのみ、ロ号を試す ★★★
    if (!設置可能フラグ && 建物情報.主用途 === "(16)項イ") {
        let 条件クリア_ロ = true;
        let 理由_ロ = ""; // ロ号がなぜダメだったかのローカルな理由

        // (ロ号の判定ロジック自体は変更なし)
        // ... largestUse, specificUseTotalArea の計算 ...
        // ... forループによる各用途チェック ...

        // 面積計算と用途構成チェックがすべて終わった後の判定
        if (条件クリア_ロ) {
            if (建物情報.延べ面積 >= 300) {
                if (!建物情報.is小規模特複フラグ) {
                    条件クリア_ロ = false;
                    理由_ロ = "「小規模特定用途複合防火対象物」に該当しないため";
                } else {
                    const 除外号リスト_ロ = ["7号", "8号", "5号", "11号", "12号", "14号", "15号"];
                    const 該当除外号 = 判定結果_令21.根拠リスト.find(号 => 除外号リスト_ロ.includes(号));
                    if (該当除外号) {
                        条件クリア_ロ = false;
                        理由_ロ = `令第21条の${該当除外号}号に該当するため`;
                    }
                }
            }
        }
        
        if (条件クリア_ロ) {
            設置可能フラグ = true;
            判定根拠号 = "ロ号";
        }
        // ★★★ 修正ポイント: ロ号が失敗しても、ここでは最終的な否決理由を設定しない ★★★
        //      ただ単に `設置可能フラグ` が false のまま、次のハ号判定に進む
    }

    // === ハ号の判定 ===
    // ★★★ イ号・ロ号で設置可能にならなかった場合にのみ、ハ号を試す ★★★
    if (!設置可能フラグ && 建物情報.主用途 === "(16)項イ") {
        let 条件クリア_ハ = true;
        let 理由_ハ = "";

        const 許可用途リスト_ハ = ["(5)項イ", "(5)項ロ"];
        if (!建物情報.複合用途リスト.every(item => 許可用途リスト_ハ.some(u => item.用途.startsWith(u)))) {
            条件クリア_ハ = false; 理由_ハ = "構成用途が(5)項イ・ロ以外を含むため";
        } else {
            const item_5イ = 建物情報.複合用途リスト.find(item => item.用途.startsWith("(5)項イ"));
            if (item_5イ && item_5イ.面積 >= 300) {
                条件クリア_ハ = false; 理由_ハ = `(5)項イ部分の面積(${item_5イ.面積}㎡)が300㎡以上のため`;
            }
        }
        if (条件クリア_ハ && !(建物情報.延べ面積 >= 300 && 建物情報.延べ面積 < 500)) {
            条件クリア_ハ = false; 理由_ハ = `延べ面積(${建物情報.延べ面積}㎡)が300～500㎡の範囲外のため`;
        }
        
        if (条件クリア_ハ) {
            設置可能フラグ = true;
            判定根拠号 = "ハ号";
        } else {
            // ★★★ 修正ポイント: ハ号もダメだった場合、ここで初めて最終的な否決理由を設定する ★★★
            否決理由 = `${理由_ハ}、ハ号の対象外です。`;
        }
    }

    // === 最終結果の返却 ===
    if (設置可能フラグ) {
        return { 設置可否: "設置可能", 根拠: `特定小規模施設に関する省令 第2条第1号【${判定根拠号}】に該当します。`, 該当号: 判定根拠号 };
    } else {
        // 全ての判定に失敗した場合の理由を設定
        // ハ号のチェックで理由が設定されていればそれを使い、なければ汎用的なメッセージを表示
        const finalReason = 否決理由 || "特定小規模施設のいずれの要件にも該当しませんでした。";
        return { 設置可否: "設置不可", 根拠: finalReason, 該当号: null };
    }
}