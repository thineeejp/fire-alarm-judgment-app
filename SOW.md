承知いたしました。そして、ありがとうございます。
その通りです。ご指摘に完全に同意します。

(5)項イが300㎡を超えるようなケースは、もはや「小規模」の範疇とは言えず、別の法令（自火報義務であれば令第21条第1項第1号）が強く適用されるため、テストケースとして不適切でした。現実的で、かつ今回の修正で最も重要な「面積の合算ロジック」を的確に検証できるテストケース1のみに絞るのが、はるかに合理的です。

ユーザー様の深い知見により、SOWの品質が向上したことに感謝いたします。
ご指示に基づき、受入基準をテストケース1のみに絞り込んだ、最終版の作業指示書を再作成します。

---

## **作業指示書 (SOW) - 【最終版】**

**プロジェクト名:** 特小自火報「ロ号」判定ロジックの面積計算に関する厳密化

**発行日:** 2025/08/18

**バージョン:** 4.0 (受入基準確定版)

---

### 1. プロジェクト概要
(変更なし) 本プロジェクトは、「自動火災報知設備 判定アプリ」の`hantei.js`に実装されている特小自火報「ロ号」の判定ロジックに存在する、重大な不備を修正するものである。
現状のロジックは、消防法施行規則第23条第4項第1号ヘに定められる「みなし従属」可能な部分の面積判定において、**その部分が建物内で最大の面積を持つ（主用途である）場合に、他の特定用途の面積と合算して上限判定を行う**という規定を考慮できていない。
この欠陥により、本来は特小自火報の対象外となるべき建物を「設置可能」と誤判定するリスクがある。本作業を通じてロジックを法令に準拠させ、判定の正確性を担保する。

### 2. 目的とゴール
(変更なし)
*   **目的:** 特小自火報「ロ号」の判定ロジックを、消防法施行規則の面積計算ルールに完全に準拠させる。
*   **ゴール:**
    1.  `hantei.js`の`特小判定実行`関数を修正し、みなし従属部分の面積判定時に、それが最大面積用途であるかどうかを考慮するロジックを組み込む。
    2.  最大面積用途である場合は、規則で定められた特定用途の面積を合算した上で、面積上限（500㎡または1000㎡）と比較するようにする。
    3.  なぜ判定が否決されたのか、ユーザーが理解できるよう、否決理由のメッセージをより具体的にする。

### 3. 作業範囲 (Scope of Work)
(変更なし)
*   **修正対象ファイル:** `hantei.js`
*   **修正対象関数:** `特小判定実行`
*   **具体的なタスク:**
    1.  関数内のロ号判定ブロックの冒頭に、**事前計算処理**を追加する。
        *   **a. 最大面積用途の特定:** `建物情報.複合用途リスト`を走査し、最も面積が大きい用途オブジェクトを特定し、変数（例: `largestUse`）に保持する。
        *   **b. 特定用途の面積合算:** ロ号で名指しされている特定用途（規則ヘ(イ)(ロ)に該当する用途）の面積を合計し、変数（例: `specificUseTotalArea`）に保持する。
    2.  構成用途を一つずつチェックする**メインの判定ループ内**を修正する。
        *   **a. 判定対象面積の動的計算:** みなし従属可能か判定する際、その用途（`item`）が事前計算で特定した`largestUse`と一致するかどうかをチェックする。
        *   **b. 条件分岐の実装:**
            *   もし `item` が `largestUse` と**一致する場合**、判定に用いる面積（`判定対象面積`）を `item.面積 + specificUseTotalArea` とする。
            *   もし `item` が `largestUse` と**一致しない場合**、判定に用いる面積（`判定対象面積`）を `item.面積` のままとする。
        *   **c. 上限判定の実施:** 上記で計算した `判定対象面積` を、その用途に定められた面積上限（原則500㎡、「未満」）と比較する。

### 4. 成果物 (Deliverables)
(変更なし)
1.  上記タスクが全て適用された `hantei.js` ファイル。
2.  実行した変更内容のサマリーレポート。

### 5. 受入基準 (Acceptance Criteria) - 【最終版】

以下の全ての基準を満たした場合に、本作業は完了とみなされる。

1.  **コードの確認:** `特小判定実行`関数内に、最大面積用途を特定する処理と、判定対象面積を動的に計算する条件分岐が正しく実装されていること。

2.  **受入テストケース: 面積合算ロジックの境界値検証**
    *   **入力:**
        *   主用途: `(16)項イ`
        *   小規模特複フラグ: **ON**
        *   複合用途1: `(5)項ロ` (寄宿舎), 面積: **480㎡**  ← 最大面積
        *   複合用途2: `(5)項イ` (ホテル), 面積: **20㎡**
        *   複合用途3: `(15)項` (事業場), 面積: **220㎡**
        *   （合計延べ面積: 720㎡）
    *   **判定ロジックの期待動作:**
        *   最大面積用途は `(5)項ロ` (480㎡)。これは「みなし従属可能」な用途である。
        *   特定用途の合計面積は `(5)項イ` の `20㎡` である。
        *   判定対象面積は合算され、`480㎡ + 20㎡ = 500㎡` と計算される。
        *   (5)項ロの面積上限は500㎡「**未満**」であるため、`500 < 500` の比較は**偽 (false)** となる。
        *   したがって、この建物はロ号の対象外と結論付けられる。
    *   **期待される最終結果:**
        *   アプリケーションが表示する特小自火報の判定結果が**「設置不可」**となること。
        *   その根拠として「**主用途((5)項ロ)と特定用途の合計面積(500㎡)が500㎡の上限に達するため**」という趣旨のメッセージが表示されること

**コード例**
/**
 * 特定小規模施設用自動火災報知設備の設置可否を判定するメイン関数 (【ロ号面積計算 厳密化版】)
 * @param {object} 判定結果_令21 - 判定実行_令21の実行結果
 * @param {object} 建物情報 - ユーザー入力から生成された建物情報オブジェクト
 * @returns {object} 判定結果オブジェクト
 */
function 特小判定実行(判定結果_令21, 建物情報) {
    // --- STEP 0: 前提条件のチェック ---
    if (判定結果_令21.根拠リスト.length === 0) {
        return { 設置可否: "判定対象外", 根拠: "自火報の設置義務がありません", 該当号: null };
    }

    let 設置可能フラグ = false;
    let 判定根拠号 = null;
    let 否決理由 = "";

    // === イ号の判定 (変更なし) ===
    const 除外号リスト_イ = ["3号", "4号", "5号", "6号", "8号", "11号", "12号", "14号", "15号"];
    const 根拠号が対象か_イ = 判定結果_令21.根拠リスト.every(号 => !除外号リスト_イ.includes(号));

    if (!根拠号が対象か_イ) {
        否決理由 = `令第21条の${判定結果_令21.根拠リスト.join(',')}号に該当するため、イ号の対象外です。`;
    } else {
        let 面積条件クリア_イ = (建物情報.延べ面積 < 300);
        if (面積条件クリア_イ) {
            設置可能フラグ = true;
            判定根拠号 = "イ号";
        } else {
            否決理由 = `延べ面積(${建物情報.延べ面積}㎡)が300㎡以上のため、イ号の対象外です。`;
        }
    }

    // === ロ号の判定 ===
    if (!設置可能フラグ) {
        if (建物情報.主用途 !== "(16)項イ") {
            否決理由 = "用途が(16)項イでないため、ロ号の対象外です。";
        } else {
            let 条件クリア_ロ = true;
            let 理由_ロ = "";

            // ★★★ STEP 1: SOWに基づく事前計算処理 ★★★
            let largestUse = { 用途: null, 面積: 0 };
            let specificUseTotalArea = 0; // 規則ヘ(イ)(ロ)に該当する特定用途の面積合計
            
            // 規則ヘ(イ)(ロ)で名指しされている、合算対象となる特定用途のリスト
            const 規則ヘの特定用途リスト = ["(2)項ニ", "(5)項イ", "(6)項イ(1)", "(6)項イ(2)", "(6)項イ(3)", "(6)項ロ", "(6)項ハ"];

            for (const item of 建物情報.複合用途リスト) {
                // a. 最大面積用途を特定
                if (item.面積 > largestUse.面積) {
                    largestUse = item;
                }
                
                // b. 特定用途の面積を合算
                if (規則ヘの特定用途リスト.some(u => item.用途.startsWith(u))) {
                    // (6)項ハは宿泊を伴うもののみ合算対象
                    if (item.用途.startsWith("(6)項ハ") && !item.入居宿泊フラグ) {
                        // 宿泊しない場合は何もしない
                    } else {
                        specificUseTotalArea += item.面積;
                    }
                }
            }

            // --- STEP 2: 各構成用途の許容性チェック ---
            const 許可用途リスト_ロ_本体 = ["(2)項イ", "(2)項ロ", "(2)項ハ", "(5)項イ", "(6)項イ(1)", "(6)項イ(2)", "(6)項イ(3)", "(6)項ロ", "(6)項ハ", "(9)項イ", "(3)項イ", "(3)項ロ", "駐車場"];
            const 規則ヘ_面積1000未満リスト = ["(11)項", "(15)項"];
            const 規則ヘ_面積500未満リスト = ["(1)項イ", "(1)項ロ", "(2)項イ", "(2)項ロ", "(2)項ハ", "(3)項イ", "(3)項ロ", "(4)項", "(5)項ロ", "(6)項イ(4)", "(6)項ニ", "(7)項", "(8)項", "(9)項ロ", "(10)項", "(12)項イ", "(12)項ロ", "(13)項イ", "(14)項"];

            for (const item of 建物情報.複合用途リスト) {
                let isItemAllowed = false;

                // チェックA: ロ号本体のリストに含まれるか？ (みなし従属が不要な用途)
                if (許可用途リスト_ロ_本体.some(u => item.用途.startsWith(u))) {
                    if (item.用途.startsWith("(6)項ハ") && !item.入居宿泊フラグ) {
                        理由_ロ = "(6)項ハ部分が宿泊を伴わないため";
                    } else if (item.用途.startsWith("(9)項イ") && item.面積 < 200) {
                        理由_ロ = "(9)項イ部分の面積が200㎡未満のため";
                    } else {
                        isItemAllowed = true;
                    }
                }
                
                // チェックB: 規則「ヘ」で許容される(みなし従属可能な)部分か？
                if (!isItemAllowed) {
                    const is1000未満対象 = 規則ヘ_面積1000未満リスト.includes(item.用途);
                    const is500未満対象 = 規則ヘ_面積500未満リスト.includes(item.用途);

                    if (is1000未満対象 || is500未満対象) {
                        const 上限面積 = is1000未満対象 ? 1000 : 500;
                        
                        // ★★★ STEP 3: SOWに基づく判定対象面積の動的計算 ★★★
                        let 判定対象面積 = item.面積;

                        // この用途が建物内で最大面積を持つ(主用途)場合、判定対象面積を再計算
                        if (item.用途 === largestUse.用途 && item.面積 === largestUse.面積) {
                            // 特定用途の面積を合算する。ただし、自分自身は重複して足さないようにする。
                            let a = item.面積;
                            let b = specificUseTotalArea;
                            //もしitemが特定用途リストに含まれるなら、specificUseTotalAreaからitemの面積を引く
                            if (規則ヘの特定用途リスト.some(u => item.用途.startsWith(u))) {
                                if (!(item.用途.startsWith("(6)項ハ") && !item.入居宿泊フラグ)) {
                                    b -= item.面積;
                                }
                            }
                            判定対象面積 = a + b;
                        }

                        if (判定対象面積 < 上限面積) {
                            isItemAllowed = true;
                        } else {
                            // ★★★ STEP 4: SOWに基づく具体的な否決理由の生成 ★★★
                            if (item.用途 === largestUse.用途) {
                                理由_ロ = `主用途(${item.用途})と特定用途の合計面積(${判定対象面積}㎡)が${上限面積}㎡の上限に達するため`;
                            } else {
                                理由_ロ = `構成用途(${item.用途})の面積(${item.面積}㎡)が${上限面積}㎡の上限を超えるため`;
                            }
                        }
                    } else {
                        理由_ロ = `構成用途に許容されない「${item.用途}」が含まれるため`;
                    }
                }
                
                if (!isItemAllowed) {
                    条件クリア_ロ = false;
                    break;
                }
            }

            // --- STEP 5: その他の要件のチェック (変更なし) ---
            if (条件クリア_ロ) {
                if (建物情報.延べ面積 >= 300) {
                    if (!建物情報.is小規模特複フラグ) {
                        条件クリア_ロ = false;
                        理由_ロ = "「小規模特定用途複合防火対象物」に該当しないため";
                    } else {
                        const 除外号リスト_ロ = ["7号", "8号", "5号", "11号", "12号", "14号", "15号"];
                        const 該当除外号 = 判定結果_令21.根拠リスト.find(号 => 除外号リスト_ロ.includes(号));
                        if (該当除外号) {
                            条件クリア_ロ = false;
                            理由_ロ = `令第21条の${該当除外号}号に該当するため`;
                        }
                    }
                }
            }
            
            // --- 最終判定 ---
            if (条件クリア_ロ) {
                設置可能フラグ = true;
                判定根拠号 = "ロ号";
            } else {
                if (!理由_ロ) { 理由_ロ = "ロ号の要件を満たしません"; }
                否決理由 = `${理由_ロ}、ロ号の対象外です。`;
            }
        }
    }

    // === ハ号の判定 (変更なし) ===
    if (!設置可能フラグ) {
        // ... (ハ号のロジックは省略)
    }

    // === 最終結果の返却 (変更なし) ===
    if (設置可能フラグ) {
        return { 設置可否: "設置可能", 根拠: `特定小規模施設に関する省令 第2条第1号【${判定根拠号}】に該当します。`, 該当号: 判定根拠号 };
    } else {
        return { 設置可否: "設置不可", 根拠: 否決理由 || "特定小規模施設のいずれの要件にも該当しませんでした。", 該当号: null };
    }
}